# yiqiu - 奕秋（部署平台）

<!-- vim-markdown-toc GFM -->

* [1. 项目概述](#1-项目概述)
    * [1.1 背景说明](#11-背景说明)
    * [1.2 项目定位](#12-项目定位)
    * [1.3 项目范围](#13-项目范围)
* [2. 技术背景](#2-技术背景)
    * [2.1 云计算基础](#21-云计算基础)
        * [云计算特征](#云计算特征)
        * [部署模式变迁](#部署模式变迁)
            * [应用部署运行模式变迁](#应用部署运行模式变迁)
* [3. 需求分析](#3-需求分析)
    * [3.1 核心需求](#31-核心需求)
        * [服务标准化](#服务标准化)
        * [有状态服务支持](#有状态服务支持)
* [4. 架构设计](#4-架构设计)
    * [4.1 整体架构](#41-整体架构)
    * [4.2 服务模型设计](#42-服务模型设计)
        * [分层模型](#分层模型)
        * [关联关系管理](#关联关系管理)
    * [4.3 服务与资源解耦](#43-服务与资源解耦)
        * [架构分层说明](#架构分层说明)
        * [4.3.1 架构收益](#431-架构收益)
        * [4.3.2 各层职责划分](#432-各层职责划分)
            * [机器管理层](#机器管理层)
            * [资源平台层](#资源平台层)
            * [服务平台层](#服务平台层)
* [5. 系统组件](#5-系统组件)
    * [5.1 yiqiu-agent](#51-yiqiu-agent)
    * [5.2 yiqiu-server](#52-yiqiu-server)
        * [5.2.1 Control 模块详细设计](#521-control-模块详细设计)
* [6. 实现案例](#6-实现案例)
    * [6.1 OpenStack 部署场景](#61-openstack-部署场景)
    * [6.2 数据模型设计](#62-数据模型设计)
* [7. 参考资料](#7-参考资料)
    * [7.1 相关项目](#71-相关项目)
    * [7.2 技术标准](#72-技术标准)
* [8. 参与开发](#8-参与开发)
    * [8.1 开发环境搭建](#81-开发环境搭建)
    * [8.2 贡献指南](#82-贡献指南)
    * [8.3 问题反馈](#83-问题反馈)

<!-- vim-markdown-toc -->

# 1. 项目概述

## 1.1 背景说明

奕秋（yiqiu）是一个专注于物理机/虚拟机部署管理的 PaaS 平台，主要解决企业级服务在物理环境下的标准化部署、运维管理问题。

**项目定位**：与 Kubernetes 形成互补关系，Kubernetes 专注于容器化应用的编排管理，而奕秋专注于物理/虚拟机环境下的服务部署管理。

**项目范围**：
- 支持物理服务器和虚拟机的统一管理
- 提供服务的标准化部署和生命周期管理
- 实现服务的自动化运维和故障自愈
- 支持有状态服务的集群化部署

**项目状态**：该项目主要面向技术研究和学习，为物理环境部署管理提供一种参考架构和实现方案。

## 1.2 项目定位

奕秋平台的核心价值在于为传统物理/虚拟机部署环境提供类似云原生的管理体验：

| 对比维度 | 传统部署 | 奕秋平台 |
|---------|---------|---------|
| 部署方式 | 手动部署 | 标准化部署 |
| 运维模式 | 人工运维 | 自动化运维 |
| 故障处理 | 人工排查 | 自动故障转移 |
| 扩缩容 | 手动操作 | 一键扩缩容 |

## 1.3 项目范围

本平台主要涵盖以下功能模块：
- 机器资源池管理
- 服务部署标准化
- 服务生命周期管理
- 服务拓扑和依赖管理
- 自动扩缩容和故障转移

# 2. 技术背景

## 2.1 云计算基础

### 云计算特征

云计算的五个基本特征：按需自助服务、广泛的网络接入、资源池化、快速弹性伸缩、可计量服务。

作为一个平台，虽然面向用户群体不同，但奕秋平台应该符合以下核心特征：
- **自助服务**：用户可以自主申请和管理资源
- **资源池化**：物理资源虚拟化为统一资源池
- **可计量服务**：支持资源使用量统计和计费

### 部署模式变迁

![Screenshot](./images/cloud.png)

#### 应用部署运行模式变迁

应用部署模式经历了从物理机到虚拟机再到云原生的演变：

```
    物理机模式 ------> 虚拟机模式 ------> 云原生模式

 +--------------+  +-------+-------+  +-------+-------+
 |              |  |  VM   |   VM  |  | Docker| Docker|
 |  +---+ +---+ |  | +---+ | +---+ |  | +---+ | +---+ |
 |  |APP| |APP| |  | |APP| | |APP| |  | |APP| | |APP| |
 |  +---+ +---+ |  | +---+ | +---+ |  | +---+ | +---+ |
 |+------------+|  +-------+-------+  +-------+-------+
 ||  Physical  ||  +---------------+  +---------------+
 |+------------+|  |  OPENSTACK    |  |      K8s      |
 +--------------+  +---------------+  +---------------+
```

**云原生**概括为 4 个要点：DevOps + 持续交付 + 微服务 + 容器

- 采用开源堆栈（K8S + Docker）进行容器化
- 基于微服务架构提高灵活性和可维护性  
- 借助敏捷方法、DevOps 支持持续迭代和运维自动化
- 利用云平台设施实现弹性伸缩、动态调度、优化资源利用率

# 3. 需求分析

## 3.1 核心需求

### 服务标准化

![Screenshot](./images/target.png)

通过服务标准化实现"您构建它，您运行它"（You build it, you run it）的目标，主要包含：

- **部署标准化**：统一的部署流程和配置管理
- **运维标准化**：自动化的监控、扩缩容和故障恢复
- **接口标准化**：统一的API和管理界面

### 有状态服务支持

**无状态服务特点**：如 nginx 或 web server（不包含数据库），自身不需要保存数据，可以随意扩容或缩容。

**有状态服务挑战**：许多有状态程序需要集群式部署，具有以下特点：
- 节点间需要形成群组关系
- 每个节点需要唯一标识（如 Kafka BrokerId, Zookeeper myid）
- 集群内部成员间需要进行通信和协调

# 4. 架构设计

## 4.1 整体架构

![Screenshot](./images/arch.png)

通过平台解决各服务运维的共性问题并统一服务运维方式，实现以下目标：

- **统一运维标准**：为不同服务提供标准化的部署、监控和运维流程
- **自动化管理**：实现服务的自动化扩缩容、故障检测和恢复
- **资源优化**：最大化资源利用率，降低运维成本

## 4.2 服务模型设计

### 分层模型

假设一个集群服务包含 4 个组件，组件间存在依赖关系（通常构成有向无环图），每个组件包含多个实例。

从架构角度可以分为三层：

- **Group层**：服务集群的顶层分组
- **Service层**：具体的服务组件
- **Unit层**：服务组件的实际运行实例

### 关联关系管理

关联关系即服务上下游的依赖关系

一般情况下，对集群中服务的配置文件的变更主要涉及两类

> * 服务本身的配置，如 redis 是否开持久化，持久化的方式，maxmemory 的大小等等
> * 服务依赖某个下游，如果下游有实例变动，则需要更新配置文件中下游的访问地址

而这的关联关系就是服务对下游的依赖描述

![Screenshot](./images/yiqiu_relation.png)

如图所示，平台管理的关联关系包括 unit 粒度和 service 粒度。

> * unit 粒度: 如 service A 依赖 server B 中所有 unit 的 ip port;
> * service 粒度：如 service A 依赖 service C 第三方服务(没有具体的 service)

将此块描述放到部署包中，依托平台达到当下游实例变更时，上游配置自动更新，以达到“You build it，you run it.”的目的

这里的上游自动更新会根据关联关系自动增加 / 删除变动的下游实例
```
ps: 讨论下
(1) 下游的实例变更时，也可以由某个中控节点自动更新上游的配置，
    缺点：此种方式集群服务的组件需要有中控模块，下游实例需要向中控节点进行注册等操作，依赖中控模块程度高
    优点：当下游服务为有状态服务时，对上游服务的配置进行更新时容易定制
(2) 上游访问下游组件时也可以是个 VIP，如 k8s 中的 Service（定义了外界访问一组 Pod 的方式）
```
## 4.3 服务与资源解耦

### 架构分层说明

```
   +---------------------+    +---------------------+
   |      platform1      |    |     platform2       |  平台功能层 (paas)
   +---------------------+    +---------------------+

--------------------------------------------------------------------------------

   +------------------------------------------------+
   | IAAS                                           |
   |   +-+  +-+  +-+  +-+  +-+  +-+  +-+  +-+  +-+  |
   |   +-+  +-+  +-+  +-+  +-+  +-+  +-+  +-+  +-+  | （实例）------ 资源平台层 (iaas)
   |   +--------+ +--------+ +--------+ +--------+  |
   |   |service1| |service2| |service3| |service*|  |
   |   +--------+ +--------+ +--------+ +--------+  |
   |__.__.__.__.__.__.__.__.__.__.__.__.__.__.__.__.|
   |   +-----------+  +-----------+  +-----------+  |
   |   | pool.bj01 |  | pool.bj02 |  | pool.nj0* |  | <---+ （资源池）
   |   +-----------+  +-----------+  +-----------+  |     |
   |                                                |     +--------- 机器管理层 (iaas)
   |   +-----------------------------------------+  |     |
   |   |                 Machine                 |  | <---+ （物理机）
   |   +-----------------------------------------+  |
   +------------------------------------------------+
```

整体架构分为三层：

- **平台功能层 (PaaS)**：面向用户的业务服务平台
- **资源平台层 (IaaS)**：资源虚拟化服务，管理 Container 容器的资源分配
- **机器管理层 (IaaS)**：管理物理机器关系，提供初始化、故障检测及监控报警功能

### 4.3.1 架构收益

实现服务管理和资源管理解耦的主要收益：

- **抽象增强**：避免在不同服务 PaaS 平台做重复工作
- **屏蔽细节**：对 PaaS 层屏蔽机器管理细节，便于实现混部等功能
- **流程简化**：提供更加直接的资源管理流程
- **扩展性**：支持多个平台功能层共享底层资源

### 4.3.2 各层职责划分

#### 机器管理层

**主要职责**：管理资源池与机器关系，维护机器在 IaaS 系统中的生命周期状态。

**核心服务**：
- `resource_pool`：资源池管理
- `resource_machine`：物理机管理

**机器生命周期状态机**：
```
                  |                    resource_pool
                  |
   +---------+    |   +--------------------------------------------------+
   |m_outside| <--+---|                     OFFLINE                      |
   +---------+    |   +--------------------------------------------------+
                  |     ^                                           ^
                  |     |(offline)                                  | (offline)
                  |     |                                           |      (backup)
   +---------+    |     |          +-----+      (init)           +------+ <---------- +-----+
   |m_outside| ---------|--------->| NEW |---------------------->|INITED|  (online)   |READY|
   +---------+    |     |          +-----+                       +------+ ----------> +-----+
                  |     |             ^                             |                  |
                  |     |             |                             |                  |
                  |     |             |(repair)                     | (abnormal)       | (abnormal)
                  |     |             |                             |                  |
                  |     |             |                             v                  v
                  |   +-------------------+    (migrate_unit)   +--------------------------+
                  |   |      ERROR        | <-------------------|       ERROR_DETECTED     |
                  |   +-------------------+                     +--------------------------+
```

**状态说明**：
- `NEW`：新机器，正在按照系统模板重装和初始化
- `INITED`：机器初始化完成，可随时部署业务
- `READY`：机器正常工作状态，接受新实例部署
- `ERROR_DETECTED`：系统发现故障，需要迁移服务
- `ERROR`：服务已迁移，进入维修程序
- `OFFLINE`：机器完成卸载，离开管理系统

**功能模块**：
- **初始化策略管理**：配置系统版本、内核版本和初始化策略
- **故障检测处理**：发现单机故障并通知上层平台进行实例迁移

#### 资源平台层

**核心服务**：
- `resource_service`：服务定义（绑定特定镜像和套餐）
- `resource_container`：服务实例管理

**主要功能**：资源分配和调度，根据服务配置在资源池中分配资源。

#### 服务平台层

**核心功能**：服务的全生命周期管理，包括部署、配置、监控等。

**实例状态机**：
```
+---------+  +---------+  +--------+  +---------+  +-----+  +-------+
|  none   |—>|allocated|—>|deployed|—>|installed|—>|ready|->|running|
+---+-----+  +----+----+  +----+---+  +----+----+  +--+--+  +-------+
    |             |            |           |          |
    |             |            |           |          |
    |             |            |           |          |
    |             |            |           |          |     +-------+
    +-------------+------------+-----------+----------+-----> error |
                                                            +-------+
```

**状态流转说明**：
1. `none → allocated`：申请 Container 资源
2. `allocated → deployed`：拉取 Program 包
3. `deployed → installed`：环境安装、配置变更、启动
4. `installed → ready`：认证变更、关联关系更新
5. `ready → running`：进入正常运行状态

**管理对象**：
- `program`：服务镜像标准化定义
- `relation`：服务间拓扑关系管理
- `config`：服务配置管理

# 5. 系统组件

## 5.1 yiqiu-agent

**核心功能**：管理程序部署和服务标准化的代理组件。

**主要职责**：
- 部署和管理 program（服务标准化抽象）
- 支持物理部署环境的特殊需求

**部署要求**：
- 必须使用绝对路径启动 yiqiu-agent
- 部署路径采用 `服务_port` 格式，支持同一服务的多实例部署
- 支持服务间的依赖关系管理

**GitHub 仓库**：[yiqiu-agent](https://github.com/meetbill/yiqiu-agent)

## 5.2 yiqiu-server

### 5.2.1 Control 模块详细设计

**架构概览**：
```
+--------------------------------------------------------+
| +---------------------------------------+              |
| | service_deploy                        |              |
| +-------+-------------------------------+              |
|         |                                              |
|         | 1                                            |
| +-------V-------------------------------+              |
| | +xingqiao_plugin+  +----------------+ |              | yiqiu-server
| | |unit_deploy    |  |command_from_mq | | Control 模块 |
| | |unit_command   |  |                | |              |
| | +-------------- +  +--/-------------+ |              |
| +-------|------------/--------|---------+              |
|         |          /          |                        |
|         | 2      / 3          | 4                      |
|         |      /              |                        |
|  +------V----V--+             |                        |
|  |     mq       |             |                        |
|  +--------------+             |                        |
+-------------------------------|------------------------+
                                |
                                |
                                |
                                V
+--------------------------------------------------------+
|  +---------+  +---------+  +---------+  +---------+    |
|  |  agent  |  |  agent  |  |  agent  |  |  agent  |    | yiqiu-agent
|  +---------+  +---------+  +---------+  +---------+    |
+--------------------------------------------------------+
```

**组件说明**：
- **unit_deploy**：管理单个实例的部署流程（Butterfly星桥插件）
- **unit_command**：向agent发送命令的插件，支持批量操作
- **command_from_mq**：实际执行命令的Handler

**部署流程**：
```
unit_deploy
    |
    +---------------------/yiqiu/command_from_mq install（部署）
    |
    +---------------------/yiqiu/command_from_mq config-changed（配置变更）
    |
    +---------------------/yiqiu/command_from_mq start（启动）
    |
    +---------------------/yiqiu/command_from_mq relation-changed（关联关系变更）
```

**命令操作**：
```
unit_command
    |
    +---------------------/yiqiu/command_from_mq command
    |
    +---------------------/yiqiu/command_from_mq command
    |
    +---------------------...
```
如上图，unit_deploy 和 unit_command 皆为 butterfly〖星桥〗插件

> unit_deploy 重点是管理一个实例的部署流程，实际命令都是 command_from_mq handler 进行执行
```
unit_deploy
    |
    +---------------------/yiqiu/command_from_mq install（部署）
    |
    +---------------------/yiqiu/command_from_mq config-changed（配置变更）
    |
    +---------------------/yiqiu/command_from_mq start（启动）
    |
    +---------------------/yiqiu/command_from_mq relation-changed（关联上下游关系）
```
> unit_command 重点是给 agent 发送命令，可对多个实例进行操作
```
unit_command
    |
    +---------------------/yiqiu/command_from_mq command
    |
    +---------------------/yiqiu/command_from_mq command
    |
    +---------------------...
```
# 6. 实现案例

## 6.1 OpenStack 部署场景

以 OpenStack 部署场景为例，说明如何使用奕秋平台进行大规模服务部署：

**场景背景**：OpenStack 需要部署在几百台物理机器上，管理对象为 OpenStack 的计算服务。

**部署流程**：

1. **服务创建**：在服务平台层创建服务
   - 在资源池中创建控制节点服务和计算节点服务
   - 为每个服务配置资源套餐和 Program 包

2. **实例添加**：服务平台向资源平台发起实例添加请求
   - 资源平台根据服务配置在资源池中分配资源
   - 创建相应的容器实例

3. **拓扑配置**：Program 包中预定义服务拓扑关系
   - 新实例根据拓扑描述自动配置上下游关系
   - 实现配置的动态更新和同步

## 6.2 数据模型设计

**设计原则**：数据模型应该基于服务模型进行分层设计，而不是基于具体的服务名称。

**错误示例分析**：
```markdown
# 不推荐的建表方式（基于服务名）
redis
proxy  
shard
cluster
```

**正确的设计思路**：
- `redis` 和 `proxy` 应该属于同一层级的服务组件
- 数据模型应该抽象为：`Service`、`Component`、`Instance` 等通用概念
- 通过配置和元数据来描述具体的服务类型

**数据模型分层**：
- **基础设施层**：机器、资源池、容器等硬件资源管理
- **服务定义层**：服务模板、Program 包、配置模板等
- **运行实例层**：实际运行的 Service、Unit 实例

# 7. 参考资料

## 7.1 相关项目

- [yiqiu-agent](https://github.com/meetbill/yiqiu-agent)：奕秋平台的代理组件
- [Butterfly 框架](https://github.com/meetbill/butterfly)：底层服务框架
- [OpenStack](https://www.openstack.org/)：开源云计算平台

## 7.2 技术标准

- 云计算架构标准（NIST SP 500-292）
- 微服务架构最佳实践
- 容器编排技术规范

# 8. 参与开发

## 8.1 开发环境搭建

```bash
# 克隆项目
git clone https://github.com/meetbill/butterfly.git
cd butterfly

# 安装依赖
pip install -r requirements.txt

# 启动服务
python butterfly/main.py
```

## 8.2 贡献指南

1. Fork 项目仓库
2. 创建功能分支
3. 提交代码变更
4. 创建 Pull Request
5. 等待代码审查

## 8.3 问题反馈

- 通过 GitHub Issues 提交问题
- 提供详细的复现步骤和环境信息
- 附上相关的日志和错误信息
